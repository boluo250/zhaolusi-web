# CLAUDE.md — 统一回答与可追溯日志规范

> 目标：为本项目提供**一致、可复现、可审计**的 AI 助手回答流程与日志格式，确保每次回答都包含清晰步骤并可直接记录到 `docs/answers-log.md`。

---

## 🧭 使用范围与目标

* **适用任务**：代码修改、调试排错、文档撰写、需求澄清、架构评审、运维脚本等。
* **总体目标**：每条回答**显式**包含步骤（RSP 流程），并产出可粘贴的**YAML 记录**。

---
  🏗️ 项目结构

  zhaolusi-web/
  ├── backend/                    # FastAPI 后端
  │   ├── main.py                # FastAPI 应用入口
  │   ├── requirements.txt       # Python 依赖
  │   ├── core/
  │   │   └── database.py        # 数据库配置
  │   ├── models/
  │   │   └── __init__.py        # SQLAlchemy 模型
  │   ├── schemas/
  │   │   └── __init__.py        # Pydantic schemas
  │   └── routers/
  │       ├── gallery.py         # 照片/视频 API
  │       └── timeline.py        # 时间轴 API
  ├── frontend/                  # 前端
  │   ├── css/style.css         # 样式文件
  │   ├── js/app.js             # 核心功能
  │   ├── index.html            # 主页面
  │   └── package.json
  ├── media/                    # 媒体文件存储
  └── venv/                     # 虚拟环境

  🎯 已实现功能

  后端 (FastAPI + SQLAlchemy)

  - ✅ 照片模型：支持分类、描述、时间戳
  - ✅ 视频模型：支持本地上传 + 外部链接(B站/YouTube)
  - ✅ 时间轴模型：事件类型、日期、地点、重要标记
  - ✅ 完整的 REST API 接口 + 自动文档生成
  - ✅ SQLite 数据库 + SQLAlchemy ORM
  - ✅ 分页、筛选、搜索功能
  - ✅ CORS 配置和静态文件服务

  前端功能

  - ✅ 首页：精选照片 + 推荐视频 + 重要事件
  - ✅ 照片页：分类筛选 + 分页显示 + Lightbox 预览
  - ✅ 视频页：分类筛选 + 播放列表支持
  - ✅ 人生轨迹：时间轴展示 + 重要事件筛选
  - ✅ 响应式设计 (Bootstrap 5)
  - ✅ 优雅的交互效果

  🚀 如何启动

  后端启动 (FastAPI)

  # 激活虚拟环境并启动 FastAPI
  source venv/bin/activate
  cd backend
  python main.py

  # 或者使用 uvicorn 直接启动
  uvicorn main:app --host 0.0.0.0 --port 8001 --reload

  前端启动

  cd frontend
  # 可以用任何静态服务器，如：
  python3 -m http.server 3000
  # 或者安装 live-server: npm install -g live-server && live-server --port=3000

```
## 🚀 回退功能

本次对话修改了代码，修改一半，服务出现错误，回退所有代码

---


## 🧷 回答日志（必须随回答产出）

> 将下方模板中的 `{{ }}` 替换为真实值，粘贴到回答末尾的「记录（Log Entry）」代码块；随后自动加入 `docs/answers-log.md`。字段保持**最小完全集**，并允许在项目需要时添加扩展字段。

```yaml
# ---- ANSWER LOG ENTRY ----
question: "回答的问题记录，原封不动"
when: "{{UTC 时间 ISO8601}}"
author: "Claude"
issue: "{{关联 Issue/需求/聊天链接}}"
objective: "{{本次回答的目标一句话}}"
steps:
  - "{{步骤 1}}"
  - "{{步骤 2}}"
  - "{{步骤 3}}"
artifacts:
  - path: "{{修改/生成的文件路径}}"
    note: "{{说明}}"
verification:
  - check: "{{构建/测试/验证项}}"
    result: "pass|fail"
    details: "{{简要结论/指标}}"
outcome: "{{最终结论/影响面}}"
next:
  - "{{下一步 1}}"
  - "{{下一步 2}}"
# ---------------------------
```

> **提示**：遇到阻塞（如 524/网络超时/权限不足）也按同样结构回答，并在「校验」部分列出排查与缓解动作（带 ✅/❌ 标签）。

---

## 🧪 常见任务最小检查清单

* **代码修改**：`build` 通过 → `lint` 无新警告 → 相关 `test` 通过 → 关键路径手测/脚本验证。
* **排错修复**：稳定复现 → 定位根因 → 最小修复 → 复现用例变绿 → 回归检查 → 记录教训。
* **文档变更**：标题与导航正确 → 示例可运行/可复制 → 链接有效 → 与 README/现行规则一致。

## 🧯 故障与超时（含 524）应对规范（ErrFlow）

1. **快速分段**：缩小分析范围（子目录/单模块），避免整仓扫描超时。
2. **超时预算**：单次操作上限 60–90s；超时则降级（离线索引/逐步扫描）。
3. **重试策略**：指数退避（1s→2s→5s→…，最多 4 次），每次只变更一个变量（范围/并发/缓存）。
4. **最小可复现**：输出最小复现脚本或命令，便于复查。
5. **记录**：在「校验」列出尝试路径与现象，全部标记 ✅/❌。

---

## 🔏 规范与边界

* 不泄露密钥/私密配置；示例使用占位符（`<TOKEN>`）。
* 对不可确定信息，显式写在「假设」。
* **不得**省略「目标/步骤/校验/结果/后续」五大块。

---

## 📐 工程与代码规范（整合 Core Beliefs / Process / Standards）

### 核心信条（Core Beliefs）

* **小步快跑**：小而可测的变更，能编译且通过测试。
* **先学再做**：阅读现有代码，按惯例实现。
* **实用优先**：结合项目现实取舍。
* **意图清晰**：代码应可读、可维护，避免炫技。

### 简单之道（Simplicity Means）

* 函数/类**单一职责**。
* 避免过早抽象；不玩“聪明技巧”。
* 需要长篇解释的实现往往过度复杂。
* 优先修改配置

### 过程（Process）

1. **规划与分阶段（IMPLEMENTATION\_PLAN.md）**

   * Stage N: \[Name]

     * **Goal**：具体可交付物
     * **Success Criteria**：可测试的结果
     * **Tests**：明确用例
     * **Status**：Not Started | In Progress | Complete
   * 全部完成后可移除此文件。

2. **实现流（红绿重构）**

   * 了解 → 写测试（红）→ 最小实现（绿）→ 重构（绿）。
   * 每次提交均通过现有/新增测试与格式检查。

3. **卡住时（最多 3 次尝试）**

   * 记录：尝试过什么、具体报错、可能原因。
   * 调研：2–3 个相似实现与差异。
   * 反思：抽象层是否合适？是否可拆分/更简单？

### 技术标准（Technical Standards）

* 组合优于继承；使用依赖注入。
* 接口优于单例；提升可测性与灵活性。
* 显式依赖；数据流清晰。
* **TDD 尽可能**；**永不**禁用测试。

### 代码质量（Code Quality）

* 每次提交：可编译、测试全绿、为新功能补充测试、遵循格式化与 Lint 规则。
* 提交前：跑格式化/静态检查，自审变更，提交信息说明**为什么**。

### 错误处理（Error Handling）

* 快速失败，报错信息具上下文。
* 在合适层面兜底，**不要**静默吞错。

### 决策框架（Decision Framework）

* 可测性、可读性、一致性、简单性、可逆性。

### 项目集成（Project Integration）

* 找到 3 个相似实现并对齐风格。
* 复用既有库/工具/测试模式。

### 质量闸门（Definition of Done）

* 测试完整并通过；
* 符合项目约定；
* 无 Lint/格式化警告；
* 提交信息清晰；
* 与实现计划一致；
* 无无编号 TODO。

### 测试指南（Testing Guidelines）

* 测行为不测实现；
* 能少断言就少；
* 用场景式命名；
* 利用既有测试工具；
* 测试必须可复现/确定性。

### 重要提醒（Never / Always）

* **切勿**：用 `--no-verify` 跳过钩子；禁用测试；提交不可编译代码；无验证地做假设。
* **务必**：增量提交；持续更新计划文档；学习既有实现；**三次失败即停下复盘**。

---




